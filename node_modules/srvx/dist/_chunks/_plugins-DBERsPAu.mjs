import { Colors } from "./_utils.cli-B2YzwlOv.mjs";

//#region src/_middleware.ts
function wrapFetch(server) {
	const fetchHandler = server.options.fetch;
	const middleware = server.options.middleware || [];
	return middleware.length === 0 ? fetchHandler : (request) => callMiddleware(request, fetchHandler, middleware, 0);
}
function callMiddleware(request, fetchHandler, middleware, index) {
	if (index === middleware.length) return fetchHandler(request);
	return middleware[index](request, () => callMiddleware(request, fetchHandler, middleware, index + 1));
}

//#endregion
//#region src/_plugins.ts
const errorPlugin = (server) => {
	const errorHandler = server.options.error;
	if (!errorHandler) return;
	server.options.middleware.unshift((_req, next) => {
		try {
			const res = next();
			return res instanceof Promise ? res.catch((error) => errorHandler(error)) : res;
		} catch (error) {
			return errorHandler(error);
		}
	});
};
const gracefulShutdownPlugin = (server) => {
	const config = server.options?.gracefulShutdown;
	if (!globalThis.process?.on || config === false || config === void 0 && (process.env.CI || process.env.TEST)) return;
	const gracefulShutdown = config === true || !config?.gracefulTimeout ? Number.parseInt(process.env.SERVER_SHUTDOWN_TIMEOUT || "") || 3 : config.gracefulTimeout;
	const forceShutdown = config === true || !config?.forceTimeout ? Number.parseInt(process.env.SERVER_FORCE_SHUTDOWN_TIMEOUT || "") || 5 : config.forceTimeout;
	let isShuttingDown = false;
	const shutdown = async () => {
		if (isShuttingDown) return;
		isShuttingDown = true;
		console.log(Colors.gray(`\nShutting down server... (timeout in ${gracefulShutdown}+${forceShutdown}s)`));
		let timeout;
		await Promise.race([server.close().finally(() => {
			clearTimeout(timeout);
			console.log(Colors.green("Server closed all connections."));
		}), new Promise((resolve) => {
			timeout = setTimeout(() => {
				console.warn(Colors.yellow(`Forcing closing connections to exit... (timeout in ${forceShutdown}s)`));
				timeout = setTimeout(() => {
					console.error(Colors.red("Could not close connections in time, force exiting."));
					resolve();
				}, 1e3);
				return server.close(true).finally(() => {
					clearTimeout(timeout);
					resolve();
				});
			}, 1e3);
		})]);
		globalThis.process.exit(0);
	};
	for (const sig of ["SIGINT", "SIGTERM"]) globalThis.process.on(sig, shutdown);
};

//#endregion
export { errorPlugin, gracefulShutdownPlugin, wrapFetch };